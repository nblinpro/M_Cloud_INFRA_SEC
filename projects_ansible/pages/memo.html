<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Déploiement Laravel - Ansible</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>

    <header>
        <div class="logo">SysAdmin_Portal</div>
        <nav>
            <ul>
                <li><a href="../index.html">Accueil</a></li>
                <li><a href="memo.html">Mémo</a></li>
                <li><a href="#" style="color:var(--accent)">Laravel</a></li>
                <li><a href="samba.html">Samba</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <h1>Déploiement Automatisé Laravel via Ansible</h1>
        <p>Documentation technique du projet d'automatisation incluant la gestion de configuration, le déploiement sécurisé (Vault) et l'optimisation serveur.</p>

        <section>
            <h2>1. Arborescence du projet</h2>
            <pre>
mon_projet_ansible/
│
├── hosts.ini                   # Inventaire
├── site.yml                    # Playbook principal
│
├── group_vars/                 # Variables partagées
│   ├── db/
│   │   └── vault.yml
│   └── web/
│       ├── vault.yml
│       └── vars.yml
│
└── roles/
    ├── database/
    │   ├── defaults/main.yml
    │   └── tasks/main.yml
    ├── php/tasks/main.yml
    ├── apache/
    │   ├── tasks/main.yml
    │   ├── handlers/main.yml
    │   └── templates/laravel.conf.j2
    ├── composer/tasks/main.yml
    ├── laravel/tasks/main.yml
    ├── selinux/tasks/main.yml
    └── firewall/tasks/main.yml
</pre>
        </section>

        <hr style="border-color: var(--secondary); margin: 3rem 0;">

        <section>
            <h2>2. Configuration Racine</h2>

            <h3>Fichier d'inventaire (hosts.ini)</h3>
            <pre>
[web]
weblaravel ansible_host=192.168.80.167 ansible_user=innosys

[db]
bddlaravel ansible_host=192.168.80.168 ansible_user=innosys
</pre>

            <h3>Playbook Principal (site.yml)</h3>
            <pre>
---
- name: Déploiement Base de Données
  hosts: db
  become: yes
  roles:
    - database

- name: Déploiement Serveur Web
  hosts: web
  become: yes
  roles:
    - php
    - apache
    - composer
    - laravel
    - selinux
    - firewall
</pre>
        </section>

        <hr style="border-color: var(--secondary); margin: 3rem 0;">

        <section>
            <h2>3. Variables & Sécurité (Vault)</h2>

            <h3>Configuration DB (group_vars/db/)</h3>
            <p>Création du coffre-fort : <code>sudo ansible-vault create group_vars/db/vault.yml</code></p>
            <pre>
# vault.yml
mysql_root_password: "RootPass123!"
laravel_db: "laravel_db"
laravel_user: "laravel_user"
laravel_password: "LaravelPass123!"
</pre>

            <h3>Configuration Web (group_vars/web/)</h3>
            <p>Création du coffre-fort : <code>sudo ansible-vault create group_vars/web/vault.yml</code></p>
            <pre>
# vault.yml
db_password: "LaravelPass123!"
db_name: "laravel_db"
db_user: "laravel_user"

# vars.yml
app_path: /var/www/laravel
db_host: 192.168.80.168
db_port: 3306
</pre>

            <h3>Sécurisation des permissions</h3>
            <pre>
sudo chown -R nicolas:nicolas group_vars

# Sécurisation dossier DB
sudo chmod 700 group_vars/db
sudo chmod 600 group_vars/db/vault.yml

# Sécurisation dossier Web
sudo chmod 700 group_vars/web
sudo chmod 600 group_vars/web/vault.yml
</pre>
        </section>

        <hr style="border-color: var(--secondary); margin: 3rem 0;">

        <section>
            <h2>Role : Database</h2>
            
            <p><strong>Fichier :</strong> <code>roles/database/defaults/main.yml</code></p>
            <pre>
---
web_server_ip: "192.168.80.167"
</pre>

            <p><strong>Fichier :</strong> <code>roles/database/tasks/main.yml</code></p>
            <pre>
---
- name: Installer MySQL server, client et PyMySQL
  dnf:
    name:
      - mysql-server
      - mysql
      - python3-PyMySQL
    state: present

- name: Activer et démarrer MySQL
  systemd:
    name: mysqld
    state: started
    enabled: yes

- name: Définir le mot de passe root MySQL
  mysql_user:
    login_user: root
    login_password: ""
    user: root
    password: "{{ mysql_root_password }}"
    host_all: yes
    check_implicit_admin: yes
  ignore_errors: yes

- name: Supprimer les utilisateurs anonymes
  mysql_user:
    login_user: root
    login_password: "{{ mysql_root_password }}"
    name: ''
    host_all: yes
    state: absent

- name: Supprimer la base de test
  mysql_db:
    login_user: root
    login_password: "{{ mysql_root_password }}"
    name: test
    state: absent

- name: Créer la base Laravel
  mysql_db:
    login_user: root
    login_password: "{{ mysql_root_password }}"
    name: "{{ laravel_db }}"
    state: present
    encoding: utf8mb4
    collation: utf8mb4_unicode_ci

- name: Créer l'utilisateur Laravel (Autorisé depuis le serveur Web)
  mysql_user:
    login_user: root
    login_password: "{{ mysql_root_password }}"
    name: "{{ laravel_user }}"
    password: "{{ laravel_password }}"
    host: "{{ web_server_ip }}"
    priv: "{{ laravel_db }}.*:ALL"
    state: present

- name: Ouvrir le port MySQL (Firewall)
  firewalld:
    port: 3306/tcp
    permanent: yes
    state: enabled

- name: Recharger firewalld
  systemd:
    name: firewalld
    state: restarted
</pre>
        </section>

        <hr style="border-color: var(--border); margin: 3rem 0;">

        <section>
            <h2>Role : PHP</h2>
            <p><strong>Fichier :</strong> <code>roles/php/tasks/main.yml</code></p>
            <pre>
---
- name: Installer dnf-plugins-core
  dnf:
    name: dnf-plugins-core
    state: present

- name: Installer EPEL Release
  dnf:
    name:
      https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm
    state: present
    disable_gpg_check: yes

- name: Activer repo REMI et module PHP 8.3
  shell: |
    dnf install -y https://rpms.remirepo.net/enterprise/remi-release-9.rpm
    dnf module reset php -y
    dnf module enable php:remi-8.3 -y
  args:
    creates: /etc/yum.repos.d/remi.repo

- name: Installer PHP et extensions
  dnf:
    name:
      - php
      - php-cli
      - php-common
      - php-fpm
      - php-mysqlnd
      - php-xml
      - php-json
      - php-zip
      - php-gd
      - php-mbstring
      - php-curl
      - php-opcache
      - git
      - unzip
      - curl
    state: present
</pre>
        </section>

        <hr style="border-color: var(--border); margin: 3rem 0;">

        <section>
            <h2>Role : Apache</h2>
            
            <p><strong>Fichier :</strong> <code>roles/apache/tasks/main.yml</code></p>
            <pre>
---
- name: Installer Apache
  dnf:
    name: httpd
    state: present

- name: Démarrer Apache
  systemd:
    name: httpd
    enabled: yes
    state: started

- name: Déployer VirtualHost Laravel
  template:
    src: laravel.conf.j2
    dest: /etc/httpd/conf.d/laravel.conf
  notify: Restart Apache
</pre>

            <p><strong>Fichier :</strong> <code>roles/apache/handlers/main.yml</code></p>
            <pre>
---
- name: Restart Apache
  systemd:
    name: httpd
    state: restarted
</pre>

            <p><strong>Fichier :</strong> <code>roles/apache/templates/laravel.conf.j2</code></p>
            <pre>
&lt;VirtualHost *:80&gt;
    DocumentRoot {{ app_path }}/public

    &lt;Directory {{ app_path }}/public&gt;
        AllowOverride All
        Require all granted
    &lt;/Directory&gt;

    ErrorLog /var/log/httpd/laravel_error.log
    CustomLog /var/log/httpd/laravel_access.log combined
&lt;/VirtualHost&gt;
</pre>
        </section>

        <hr style="border-color: var(--border); margin: 3rem 0;">

        <section>
            <h2>Role : Composer</h2>
            <p><strong>Fichier :</strong> <code>roles/composer/tasks/main.yml</code></p>
            <pre>
---
- name: Télécharger Composer
  get_url:
    url: https://getcomposer.org/download/latest-stable/composer.phar
    dest: /usr/local/bin/composer
    mode: "0755"
</pre>
        </section>

        <hr style="border-color: var(--border); margin: 3rem 0;">

        <section>
            <h2>Role : Laravel</h2>
            <p><strong>Fichier :</strong> <code>roles/laravel/tasks/main.yml</code></p>
            <pre>
---
- name: Créer dossier application
  file:
    path: "{{ app_path }}"
    state: directory
    mode: "0755"

- name: Installer Laravel
  command: /usr/local/bin/composer create-project laravel/laravel .
  args:
    chdir: "{{ app_path }}"
    creates: "{{ app_path }}/artisan"

- name: Permissions Apache
  file:
    path: "{{ app_path }}"
    recurse: yes
    owner: apache
    group: apache

- name: Droits écriture storage/cache
  file:
    path: "{{ item }}"
    recurse: yes
    mode: "0775"
  loop:
    - "{{ app_path }}/storage"
    - "{{ app_path }}/bootstrap/cache"

- name: Générer clé Laravel
  command: sudo -u apache php artisan key:generate
  args:
    chdir: "{{ app_path }}"

- name: Configurer .env
  lineinfile:
    path: "{{ app_path }}/.env"
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  loop:
    - { regexp: '^DB_CONNECTION=', line: 'DB_CONNECTION=mysql' }
    - { regexp: '^DB_HOST=',       line: 'DB_HOST={{ db_host }}' }
    - { regexp: '^DB_PORT=',       line: 'DB_PORT={{ db_port }}' }
    - { regexp: '^DB_DATABASE=',   line: 'DB_DATABASE={{ db_name }}' }
    - { regexp: '^DB_USERNAME=',   line: 'DB_USERNAME={{ db_user }}' }
    - { regexp: '^DB_PASSWORD=',   line: 'DB_PASSWORD={{ db_password }}' }

- name: Exécuter migrations
  command: sudo -u apache php artisan migrate --force
  args:
    chdir: "{{ app_path }}"
</pre>
        </section>

        <hr style="border-color: var(--border); margin: 3rem 0;">

        <section>
            <h2>Rôles : Sécurité (SELinux & Firewall)</h2>

            <p><strong>Fichier :</strong> <code>roles/selinux/tasks/main.yml</code></p>
            <pre>
---
- name: Autoriser connexion réseau Apache
  command: setsebool -P httpd_can_network_connect on

- name: Appliquer contexte SELinux
  command: chcon -R -t httpd_sys_rw_content_t {{ item }}
  loop:
    - "{{ app_path }}/storage"
    - "{{ app_path }}/bootstrap/cache"
    - "{{ app_path }}/.env"
</pre>

            <p><strong>Fichier :</strong> <code>roles/firewall/tasks/main.yml</code></p>
            <pre>
---
- name: Ouvrir ports HTTP/HTTPS
  firewalld:
    port: "{{ item }}/tcp"
    permanent: yes
    state: enabled
  loop: [80, 443]
</pre>
        </section>
<section style="background-color: var(--secondary); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--accent); margin-top: 3rem;">
    <h3>Conclusion</h3>
    <p>Ce projet démontre la mise en place complète d’un déploiement Laravel automatisé via Ansible, incluant la base de données, le serveur web, la sécurité SELinux et le firewall.</p>
</section>
    </main>

    <footer>
        <p><a href="../index.html">← Retour à l'accueil</a></p>
    </footer>
</body>
</html>
