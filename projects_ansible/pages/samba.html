<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DÃ©ploiement Samba - Ansible</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>

    <header>
        <div class="logo">SysAdmin_Portal</div>
        <nav>
            <ul>
                <li><a href="https://nblinpro.github.io/portfolio/index.html">Accueil</a></li>
                <li><a href="https://nblinpro.github.io/portfolio/pages/parcours.html">Parcours</a></li>
                <li><a href="../projets_ansible.html">Projets Ansible</a></li>
                <li><a href="mailto:nicolas.blin.pro1@gmail.com" class="btn btn-primary" style="padding: 0.5rem 1rem;">Me Contacter</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <h1>DÃ©ploiement Serveur de Fichiers Samba via Ansible</h1>
        <p>Documentation technique du projet d'automatisation pour la mise en place d'un serveur de fichiers sÃ©curisÃ©, incluant la gestion des utilisateurs, des groupes et des accÃ¨s rÃ©seaux.</p>

        <section>
            <h2>1. Arborescence du projet</h2>
            <pre>
mon_projet_ansible/
â”œâ”€â”€ group_vars
â”‚   â””â”€â”€ samba
â”‚       â””â”€â”€ vault.yml
â”œâ”€â”€ hosts.ini
â”œâ”€â”€ roles
â”‚   â””â”€â”€ samba
â”‚       â”œâ”€â”€ defaults
â”‚       â”‚   â””â”€â”€ main.yml
â”‚       â”œâ”€â”€ handlers
â”‚       â”‚   â””â”€â”€ main.yml
â”‚       â””â”€â”€ tasks
â”‚           â””â”€â”€ main.yml
â””â”€â”€ samba.yml
</pre>
        </section>

        <hr style="border-color: var(--secondary); margin: 3rem 0;">

        <section>
            <h2>2. Configuration Racine</h2>

            <h3>Fichier d'inventaire (hosts.ini)</h3>
            <pre>
[samba]
srv_samba ansible_host=192.168.80.175 ansible_user=innosys
</pre>

            <h3>Playbook Principal (samba.yml)</h3>
            <pre>
---
- name: Configuration du Serveur de Fichiers (Samba)
  hosts: samba
  become: yes
  vars_files:
    - group_vars/samba/vault.yml
  roles:
    - samba
</pre>
        </section>

        <hr style="border-color: var(--secondary); margin: 3rem 0;">

        <section>
            <h2>3. Variables & SÃ©curitÃ© (Vault)</h2>

            <h3>Configuration SecrÃ¨te (group_vars/samba/)</h3>
            <p>CrÃ©ation du coffre-fort : <code>ansible-vault create group_vars/samba/vault.yml</code></p>
            <pre>
# vault.yml
vault_samba_pass_test: "test"
vault_samba_pass_admin: "innosys"
</pre>

            <h3>SÃ©curisation des permissions</h3>
            <pre>
sudo chown -R nicolas:nicolas group_vars
sudo chmod 700 group_vars/samba
sudo chmod 600 group_vars/samba/vault.yml
</pre>
        </section>

        <hr style="border-color: var(--secondary); margin: 3rem 0;">

        <section>
            <h2>4. Role : Samba</h2>
            <p>Ce rÃ´le gÃ¨re l'installation, la crÃ©ation des utilisateurs et la configuration du partage.</p>

            <h3>Variables par dÃ©faut (defaults/main.yml)</h3>
            <pre>
---
samba_share_path: "/srv/partage_commun"
samba_group_name: "partageurs"
samba_user_test: "test"
# Par dÃ©faut, l'admin samba sera l'utilisateur avec lequel Ansible se connecte
samba_admin_user: "innosys"
</pre>

            <h3>Gestionnaire de service (handlers/main.yml)</h3>
            <pre>
---
- name: Restart Samba
  ansible.builtin.service:
    name: smbd
    state: restarted
</pre>

            <h3>TÃ¢ches principales (tasks/main.yml)</h3>
            <pre>
---
- name: Installer Samba
  ansible.builtin.apt:
    name: samba
    state: present
    update_cache: yes

- name: CrÃ©er le groupe de partage "{{ samba_group_name }}"
  ansible.builtin.group:
    name: "{{ samba_group_name }}"
    state: present

- name: CrÃ©er l'utilisateur test (sans login)
  ansible.builtin.user:
    name: "{{ samba_user_test }}"
    shell: /usr/sbin/nologin
    create_home: no
    groups: "{{ samba_group_name }}"
    append: yes
    state: present

- name: Ajouter l'admin "{{ samba_admin_user }}" au groupe "{{ samba_group_name }}"
  ansible.builtin.user:
    name: "{{ samba_admin_user }}"
    groups: "{{ samba_group_name }}"
    append: yes

- name: Configurer le dossier partagÃ© (Permissions 2770)
  ansible.builtin.file:
    path: "{{ samba_share_path }}"
    state: directory
    owner: root
    group: "{{ samba_group_name }}"
    # 2770 = setgid (2) + rwx user (7) + rwx group (7) + no permission others (0)
    mode: '2770'

# Configuration des mots de passe Samba via smbpasswd
- name: DÃ©finir le mot de passe Samba pour test
  ansible.builtin.shell: >
    (echo '{{ vault_samba_pass_test }}'; echo '{{ vault_samba_pass_test }}') | smbpasswd -s -a {{ samba_user_test }}
  register: smb_test_result
  changed_when: "'Added user' in smb_test_result.stdout"
  no_log: true

- name: DÃ©finir le mot de passe Samba pour l'Admin
  ansible.builtin.shell: >
    (echo '{{ vault_samba_pass_admin }}'; echo '{{ vault_samba_pass_admin }}') | smbpasswd -s -a {{ samba_admin_user }}
  register: smb_admin_result
  changed_when: "'Added user' in smb_admin_result.stdout"
  no_log: true

# Ajout de la configuration dans smb.conf
- name: Configurer le partage dans /etc/samba/smb.conf
  ansible.builtin.blockinfile:
    path: /etc/samba/smb.conf
    marker: "# {mark} ANSIBLE MANAGED BLOCK - PARTAGE COMMUN"
    block: |
      [DossierCommun]
          comment = Partage pour test et moi
          path = {{ samba_share_path }}
          browsable = yes
          read only = no
          guest ok = no
          valid users = @{{ samba_group_name }}
          create mask = 0660
          directory mask = 0770
          force group = {{ samba_group_name }}
  notify: Restart Samba

- name: Afficher les informations de connexion au partage
  ansible.builtin.debug:
    msg:
      - "=================================================================="
      - "âœ… Installation terminÃ©e avec succÃ¨s !"
      - "ğŸ“‚ Nom du partage : DossierCommun"
      - "------------------------------------------------------------------"
      # Note les 4 antislashes au dÃ©but et les 2 au milieu
      - "ğŸ–¥ï¸  Windows (Lecteur RÃ©seau) : \\\\{{ ansible_host }}\\\\DossierCommun"
      - "ğŸ§ Linux / Mac (Samba)      : smb://{{ ansible_host }}/DossierCommun"
      - "ğŸ’¾ WinSCP (Protocole SFTP)  : sftp://{{ ansible_host }}/srv/partage_commun"
      - "=================================================================="
</pre>
        </section>

        <section style="background-color: var(--secondary); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--accent); margin-top: 3rem;">
            <h3>Conclusion</h3>
            <p>Ce projet dÃ©montre la mise en place d'un serveur de fichiers collaboratif. Il gÃ¨re automatiquement les permissions complexes (SetGID 2770), sÃ©curise les mots de passe via Ansible Vault et fournit les instructions de connexion pour les environnements Windows, Linux et WinSCP.</p>
        </section>

    </main>

    <footer>
        <p>Â© 2025 Nicolas. Tous droits rÃ©servÃ©s.</p>
        <p><a href="../index.html">â† Retour Ã  l'accueil</a></p>
    </footer>
</body>
</html>
